{{ extend SEARCHING_GRID }}

{{ block js }}
    {{ import simplejson  }}
    {{ from gluon.serializers import custom_json  }}
    {{def json_pretty(data):  return XML(simplejson.dumps( data,  default=custom_json, indent=4)) }}
    <script type="text/javascript">

        var {{=cid}}__w2grid_options = {
            
                    {{ url_kwargs = dict( vars={'_grid':True, 'data_name':data_name}, user_signature=True)  }}
            
                    {{ if w2ui_coldata_oldschool_js: }}
                        // for migration purposes -- keeping old columns definitions  and old grid_function  
                         url: "{{ =URL(controller, grid_function+'.json', **url_kwargs) }}",  // todo: extension="json"
                         {{ =w2ui_coldata_oldschool_js }}
                            
                    {{ else: }}
                       
                         url: "{{ =URL( grid_function+'.json', **url_kwargs) }}",  // todo: extension="json"
                       
                         columns:  {{=json_pretty( w2ui_columns ) }},
                         sortData: {{=json_pretty( w2ui_sort ) }},
   
                    {{ pass }}
                        
            {{ block w2ui_crud_toolbar }}

                    show: {
                        {{ if auth.has_permission('add', data_name ): }}
                            toolbarAdd: true,
                        {{ pass }}
                        {{ if auth.has_permission('edit',  data_name): }}
                            toolbarEdit: true,
                        {{ pass }}
                        {{ if auth.has_permission('delete', data_name): }}
                            toolbarDelete: true,
                        {{ pass }}
                    },


                    extra_toolbar: {
                        items: [
                            {{ if auth.has_permission('add', data_name): }}
                                {type: 'button', id: 'import', caption: "{{ =T('button__import') }}", img: 'icon-page'},
                                {type: "break"},
                                // {type: "button", caption: "{{ =T('subject_subject__btn_quick_add') }}", icon: "w2ui-icon-plus", onClick: addSubject}
                            {{ pass }}

                            {{ if w2ui_extra_toolbar_append:
                                 for item in w2ui_extra_toolbar_append:
                                       =item
                                       =', '
                                  pass 
                                pass 
                            }}
                    
                        ]
                    },


                    onAdd: function(event){
                        // addUser();
                        //ajaxForm_popup(popup_name, title, form_name, url,  data, options)
                        ajaxForm_popup(
                                      "{{ =data_name }}", 
                                      "{{ =T( data_name +'__add_form' ) }}", // or  context_name: {{#=context_name}}+ ..?
                                      "add_{{ =data_name }}",
                                      "{{ =crud_urls.add }}"
                                       );
                        
                    },
                    onEdit: function(event){

                    /* ajaxForm_popup(
                                      "{{ =data_name }}",
                                      "{{ =T( data_name +'__edit_form' ) }}", // or  context_name: {{#=context_name}}+ ..?
                                      "edit_{{ =data_name }}",
                                      "{{ =crud_urls.edit }}"  +'/'+event.recid
                                       );
                    */

                        // var url = "{{=crud_urls.edit   }}" +'/'+event.recid
                        var url = "{{=crud_urls.edit}}".replace('___id___', ''+event.recid); // to let vars appear in URL
                        if (event.newWindow){
                            openTab(url);
                        } else {
                            document.location = url;
                        }

                    },
                    // w2ui_options_extra (optional)
                    {{ if w2ui_options_extra:
                        =json_pretty ( w2ui_options_extra ).strip('{}') 
                    pass }}
                    
            {{ end }}
            
        };

    $(function() {
        w2ui__grid('{{=cid}}');
    });

    {{ block w2ui_extra_js }}
    //  w2ui extra JS
    {{ end }}
    </script>

{{ end }}


{{ block after_grid }} 
{{
    host = request.env.http_host
    if host.startswith('localhost') or host.startswith('127.0.0.1') or host.startswith('0.0.0.0'):
        =response.toolbar()
    pass
}}
{{ end }}
